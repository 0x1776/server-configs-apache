# For more information about the configurations used
# in this file, please see the Travis CI documentation:
# http://docs.travis-ci.com

after_success:

  # Temporary workaround for:
  # https://github.com/travis-ci/travis-ci/issues/929

  - python travis_after_all.py
  - export $(cat .to_export_back)
  - |

    # If all the tests pass in all the runtimes, make
    # Travis automatically download and execute the following

    if [ "$BUILD_LEADER" == "YES" ]; then
      if [ "$BUILD_AGGREGATE_STATUS" == "others_succeeded" ]; then \

        # Clean up helper files
        rm -rf travis_after_all.py .to_export_back && \

        # Commit any changes generated by the build process
        curl -sSL "https://raw.githubusercontent.com/h5bp-bot/scripts/0.6.1/commit_build_changes.sh" |
          bash -s -- --branch "master" \
                     --commands "npm run build" \
                     --commit-message "Update generated content [skip ci]";

      fi
    fi

before_script:
  - ./bin/setup/setup.sh

env:
  global:
    - BUILD_DIR="$TRAVIS_BUILD_DIR"
    - secure: "hrF9yJtb9rnrhPwZ8aYUaFXjxWoomkOF0mg6vbFCZz2VB0AeITsA+DlLTdsHptUwKQG7BoE8phSK71w61bylFNyL5DYexQtdwzZ1XS+nUijKbbVazBE791/fcqd4aFAevpm3bzBu7FYcSl/dpnEUXzYOCcnPs8LgRbLZit0hK/4="

git:
  depth: 5

language: node_js

matrix:
  include:

    # Tests for Apache 2.2.x

    - env:
        - APACHE_VERSION="2.2.x"
      node_js: "iojs"
      script:
        - sudo service apache2 restart
        - npm test

    - env:
        - APACHE_VERSION="2.2.x"
      node_js: "0.12"
      script:
        - sudo service apache2 restart
        - npm test


    # Tests for Apache 2.4.x

    - env:
        - APACHE_VERSION="2.4.x"
      node_js: "iojs"
      script:
        - sudo /usr/local/apache2/bin/apachectl start
        - npm test

    - env:
        - APACHE_VERSION="2.4.x"
      node_js: "0.12"
      script:
        - sudo /usr/local/apache2/bin/apachectl start
        - npm test

script:
  - curl -sSLo travis_after_all.py https://raw.github.com/dmakhno/travis_after_all/master/travis_after_all.py
